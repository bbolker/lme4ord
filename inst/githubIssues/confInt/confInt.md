

We simulate some data.

```r
set.seed(1)
n <- 95 # 100
m <- 475 # 500
dl <- dims_to_vars(data.list(y = 1 * (matrix(rnorm(n * m), n, m) > 0),
                             x = rnorm(n), z = rnorm(m),
                             dimids = c("sites", "species")))
df <- as.data.frame(dl)
phy <- rtree(n = m)
phy <- compute.brlen(phy, method = "Grafen", power = 0.1)
Vphy <- stanCov(vcv(phy))
dimnames(Vphy) <- rep(list(1:m), 2)
covList <- list(species = Vphy)
form <- y ~ x*z + (x | species)
parsedForm <- glmercFormula(form, df, covList = covList)
covarSim <- c(0.5, -0.2, 0.5)
parsedForm <- within(parsedForm, Lambdat@x[] <- mapToCovFact(covarSim))
X <- model.matrix(nobars(form), df) # fixed effects design matrix
Z <- t(parsedForm$Lambdat %*% parsedForm$Zt) # random effects design
                                             # matrix with
                                             # phylogenetic
                                             # covariances
fixefSim <- rnorm(ncol(X)) # fixed effects
u <- rnorm(ncol(Z)) # whitened random effects
p <- plogis(as.numeric(X %*% fixefSim + Z %*% u)) # probability of observation
dl$y <- rbinom(nrow(df), 1, p) # presence-absence data
df <- as.data.frame(dl) # reconstruct the data frame with new
                        # structured response
```

Fit the generating model to the simulated data.

```r
mod <- glmerc(form, df, covMat = covMat,
              optControl = list(iprint = 0L, maxfun = 500))
```

Compute the Wald confidence intervals two ways.

```r
centDfun <- function(par) mod$dfun(par) - mod$opt$fval
getCI <- function(H, expandFac = 1) {
    ans <- sweep(outer(sqrt(diag(solve(0.5*H))), expandFac * 1.96 * c(-1, 1)),
                 1, mod$opt$par, "+")
    colnames(ans) <- c("lower", "upper")
    ans
}
hh <- lme4:::deriv12(centDfun, mod$opt$par)$Hessian
ci <- getCI(hh)
hhRich <- hessian(centDfun, mod$opt$par)
ciRich <- getCI(hhRich)
```


```r
params <- as.data.frame(cbind(estimated = mod$opt$par,
                              true = c(covar = covarSim, fixef = fixefSim),
                              ci))
params$parameter <- rownames(params)
ggplot(params) +
    geom_point(aes(estimated, parameter)) +
    geom_point(aes(true, parameter), col = "red") +
    geom_segment(aes(lower, parameter, xend = upper, yend = parameter))
```

![plot of chunk unnamed-chunk-5](figure/unnamed-chunk-5-1.png) 



Compute the deviance profile for a particular parameter.

```r
pfun <- mkPfun(whichPar <- 1)
expFac <- 10 * apply(ci, 1, diff)
grd <- seq(-expFac[whichPar] + ci[whichPar, 1],
            expFac[whichPar] + ci[whichPar, 2], length = 10)
pro <- sapply(grd, pfun)
```

```
## npt = 8 , n =  6 
## rhobeg =  0.4940131 , rhoend =  4.940131e-07 
##    0.049:   9:      15.3990;-0.0836098 0.666336 -2.47007 -2.16785 -1.49679 0.0987222 
##   0.0049:  18:     0.529328;-0.100360 0.697784 -2.49289 -2.13521 -1.51493 0.0822445 
##  0.00049:  29:    -0.684781;-0.103004 0.690024 -2.49401 -2.13180 -1.51939 0.0889822 
##  4.9e-05:  36:    -0.696054;-0.103209 0.689774 -2.49404 -2.13219 -1.51859 0.0882370 
##  4.9e-06:  40:    -0.696054;-0.103209 0.689774 -2.49404 -2.13219 -1.51859 0.0882370 
##  4.9e-07:  56:    -0.698712;-0.103234 0.689765 -2.49404 -2.13218 -1.51859 0.0882613 
## At return
## 145:   -0.73668413: -0.103483 0.689675 -2.49392 -2.13194 -1.51863 0.0884830
## npt = 8 , n =  6 
## rhobeg =  0.4987849 , rhoend =  4.987849e-07 
##    0.050:   9:    -0.674019;-0.103483 0.689675 -2.49392 -2.13194 -1.51863 0.0884830 
##   0.0050:  12:    -0.674019;-0.103483 0.689675 -2.49392 -2.13194 -1.51863 0.0884830 
##  0.00050:  19:    -0.674019;-0.103483 0.689675 -2.49392 -2.13194 -1.51863 0.0884830 
##  5.0e-05:  28:    -0.803216;-0.102844 0.688456 -2.49395 -2.13095 -1.51957 0.0882869 
##  5.0e-06:  33:    -0.803216;-0.102844 0.688456 -2.49395 -2.13095 -1.51957 0.0882869 
##  5.0e-07:  67:    -0.838110;-0.102895 0.688224 -2.49384 -2.13090 -1.51954 0.0883244 
## At return
##  90:   -0.84263822: -0.102905 0.688197 -2.49383 -2.13090 -1.51954 0.0883306
## npt = 8 , n =  6 
## rhobeg =  0.4987655 , rhoend =  4.987655e-07 
##    0.050:   9:    -0.779893;-0.102905 0.688197 -2.49383 -2.13090 -1.51954 0.0883306 
##   0.0050:  12:    -0.779893;-0.102905 0.688197 -2.49383 -2.13090 -1.51954 0.0883306 
##  0.00050:  19:    -0.779893;-0.102905 0.688197 -2.49383 -2.13090 -1.51954 0.0883306 
##  5.0e-05:  30:    -0.891242;-0.102545 0.687245 -2.49396 -2.12985 -1.51974 0.0883874 
##  5.0e-06:  37:    -0.901682;-0.102446 0.687159 -2.49385 -2.12988 -1.51964 0.0883898 
##  5.0e-07:  76:    -0.925634;-0.102389 0.686922 -2.49383 -2.12986 -1.51963 0.0883497 
## At return
##  96:   -0.92788470: -0.102393 0.686908 -2.49382 -2.12985 -1.51963 0.0883527
## npt = 8 , n =  6 
## rhobeg =  0.4987642 , rhoend =  4.987642e-07 
##    0.050:   9:    -0.865048;-0.102393 0.686908 -2.49382 -2.12985 -1.51963 0.0883527 
##   0.0050:  12:    -0.865048;-0.102393 0.686908 -2.49382 -2.12985 -1.51963 0.0883527 
##  0.00050:  21:    -0.950055;-0.100660 0.683964 -2.49879 -2.11981 -1.52106 0.0843293 
##  5.0e-05:  30:    -0.954374;-0.100637 0.684052 -2.49850 -2.11961 -1.52137 0.0842176 
##  5.0e-06:  43:    -0.985672;-0.100714 0.683871 -2.49841 -2.11954 -1.52131 0.0843191 
##  5.0e-07:  50:    -0.985672;-0.100714 0.683871 -2.49841 -2.11954 -1.52131 0.0843191 
## At return
##  64:   -0.98618073: -0.100716 0.683868 -2.49841 -2.11954 -1.52131 0.0843198
## npt = 8 , n =  6 
## rhobeg =  0.4996821 , rhoend =  4.996821e-07 
##    0.050:   9:    -0.923461;-0.100716 0.683868 -2.49841 -2.11954 -1.52131 0.0843198 
##   0.0050:  12:    -0.923461;-0.100716 0.683868 -2.49841 -2.11954 -1.52131 0.0843198 
##  0.00050:  19:    -0.923461;-0.100716 0.683868 -2.49841 -2.11954 -1.52131 0.0843198 
##  5.0e-05:  28:     -1.02753;-0.100693 0.682837 -2.49834 -2.11895 -1.52431 0.0849196 
##  5.0e-06:  39:     -1.03919;-0.100648 0.682753 -2.49831 -2.11889 -1.52427 0.0849950 
##  5.0e-07:  48:     -1.04032;-0.100660 0.682746 -2.49830 -2.11889 -1.52427 0.0849894 
## At return
##  95:    -1.0488092: -0.100682 0.682691 -2.49828 -2.11888 -1.52427 0.0850016
## npt = 8 , n =  6 
## rhobeg =  0.4996564 , rhoend =  4.996564e-07 
##    0.050:   9:    -0.986040;-0.100682 0.682691 -2.49828 -2.11888 -1.52427 0.0850016 
##   0.0050:  12:    -0.986040;-0.100682 0.682691 -2.49828 -2.11888 -1.52427 0.0850016 
##  0.00050:  19:     -1.03873;-0.100764 0.681992 -2.49891 -2.12014 -1.52749 0.0884863 
##  5.0e-05:  28:     -1.08031;-0.101107 0.682759 -2.49761 -2.12101 -1.52599 0.0898086 
##  5.0e-06:  33:     -1.08031;-0.101107 0.682759 -2.49761 -2.12101 -1.52599 0.0898086 
##  5.0e-07:  67:     -1.12672;-0.101247 0.682458 -2.49748 -2.12096 -1.52596 0.0898490 
## At return
##  86:    -1.1278090: -0.101250 0.682451 -2.49747 -2.12096 -1.52596 0.0898503
## npt = 8 , n =  6 
## rhobeg =  0.4994949 , rhoend =  4.994949e-07 
##    0.050:   9:     -1.06503;-0.101250 0.682451 -2.49747 -2.12096 -1.52596 0.0898503 
##   0.0050:  12:     -1.06503;-0.101250 0.682451 -2.49747 -2.12096 -1.52596 0.0898503 
##  0.00050:  19:     -1.06503;-0.101250 0.682451 -2.49747 -2.12096 -1.52596 0.0898503 
##  5.0e-05:  29:     -1.20597;-0.101012 0.682130 -2.49618 -2.11962 -1.52517 0.0909877 
##  5.0e-06:  36:     -1.21079;-0.101015 0.682042 -2.49622 -2.11963 -1.52525 0.0909340 
##  5.0e-07:  49:     -1.22095;-0.101045 0.681978 -2.49619 -2.11962 -1.52524 0.0909438 
## At return
##  59:    -1.2211053: -0.101045 0.681977 -2.49619 -2.11962 -1.52524 0.0909446
## npt = 8 , n =  6 
## rhobeg =  0.499237 , rhoend =  4.99237e-07 
##    0.050:   9:     -1.15808;-0.101045 0.681977 -2.49619 -2.11962 -1.52524 0.0909446 
##   0.0050:  12:     -1.15808;-0.101045 0.681977 -2.49619 -2.11962 -1.52524 0.0909446 
##  0.00050:  19:     -1.15808;-0.101045 0.681977 -2.49619 -2.11962 -1.52524 0.0909446 
##  5.0e-05:  29:     -1.28852;-0.100823 0.681723 -2.49489 -2.11834 -1.52441 0.0920851 
##  5.0e-06:  36:     -1.29281;-0.100823 0.681637 -2.49494 -2.11834 -1.52449 0.0920350 
##  5.0e-07:  49:     -1.30292;-0.100846 0.681577 -2.49489 -2.11833 -1.52447 0.0920510 
## At return
##  76:    -1.3087404: -0.100863 0.681539 -2.49487 -2.11832 -1.52448 0.0920535
## npt = 8 , n =  6 
## rhobeg =  0.4989748 , rhoend =  4.989748e-07 
##    0.050:   9:     -1.24546;-0.100863 0.681539 -2.49487 -2.11832 -1.52448 0.0920535 
##   0.0050:  12:     -1.24546;-0.100863 0.681539 -2.49487 -2.11832 -1.52448 0.0920535 
##  0.00050:  19:     -1.24546;-0.100863 0.681539 -2.49487 -2.11832 -1.52448 0.0920535 
##  5.0e-05:  26:     -1.25544;-0.101108 0.681533 -2.49487 -2.11877 -1.52513 0.0929875 
##  5.0e-06:  43:     -1.29146;-0.101256 0.681284 -2.49487 -2.11867 -1.52505 0.0930751 
##  5.0e-07:  58:     -1.29549;-0.101286 0.681264 -2.49486 -2.11866 -1.52505 0.0930645 
## At return
##  74:    -1.2961502: -0.101287 0.681260 -2.49485 -2.11866 -1.52505 0.0930653
## npt = 8 , n =  6 
## rhobeg =  0.498971 , rhoend =  4.98971e-07 
##    0.050:   9:     -1.23276;-0.101287 0.681260 -2.49485 -2.11866 -1.52505 0.0930653 
##   0.0050:  12:     -1.23276;-0.101287 0.681260 -2.49485 -2.11866 -1.52505 0.0930653 
##  0.00050:  19:     -1.23276;-0.101287 0.681260 -2.49485 -2.11866 -1.52505 0.0930653 
##  5.0e-05:  26:     -1.24992;-0.101287 0.681260 -2.49485 -2.11866 -1.52380 0.0930653 
##  5.0e-06:  45:     -1.28899;-0.101219 0.680837 -2.49493 -2.11863 -1.52373 0.0932359 
##  5.0e-07:  59:     -1.30025;-0.101255 0.680758 -2.49490 -2.11867 -1.52368 0.0932170 
## At return
##  66:    -1.3002575: -0.101254 0.680758 -2.49490 -2.11867 -1.52368 0.0932169
```

Plot the results

```r
plot(interpSpline(grd, pro), lwd = 3) # profiled deviance
abline(v = c(covarSim, fixefSim)[whichPar], col = "red") # true value
abline(v = mod$opt$par[whichPar], col = "blue") # mle
abline(h = c(0, qchisq(0.95, 1)), lty = 2) # approximate LR confidence limits on profiled deviance
abline(v = ci[whichPar, ], lty = 2) # approximate walk confidence limits on parameter
```

![plot of chunk unnamed-chunk-8](figure/unnamed-chunk-8-1.png) 
